<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>エルボ距離計算</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --ios-bg: #000000;
            --ios-card: #1c1c1e;
            --ios-input: #2c2c2e;
            --ios-border: #3a3a3c;
            --ios-orange: #ff9f0a;
            --ios-orange-dark: #995c00;
            --ios-orange-light: #ffaa33;
            --accent-90: #5e5ce6;
            --accent-45: #30d158;
            --accent-dist: #3b82f6;
            --ios-secondary: #8e8e93;
        }

        * {
            box-sizing: border-box;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            background: var(--ios-bg);
            font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 6px;
            overflow-x: hidden;
            touch-action: pan-y;
            min-height: 100vh;
        }

        .tab-wrapper {
            position: sticky;
            top: 0;
            z-index: 100;
            width: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 12px 0;
            display: flex;
            justify-content: center;
        }

        .tab-container {
            display: flex;
            background: var(--ios-card);
            padding: 4px;
            border-radius: 18px;
            width: 95%;
            max-width: 420px;
            border: 1px solid var(--ios-border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .tab-button {
            flex: 1;
            padding: 10px 4px;
            border: none;
            background: transparent;
            color: #d1d1d6;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            border-radius: 14px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
        }

        @media (min-width: 380px) {
            .tab-button { font-size: 15px; padding: 12px; }
        }

        .tab-button.active {
            background: linear-gradient(180deg, #636366 0%, #48484a 100%);
            color: #ffffff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.15);
        }

        .main-container {
            width: 100%;
            max-width: 420px;
            background: var(--ios-card);
            border-radius: 28px;
            padding: 24px 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            margin-bottom: 40px;
        }

        .ios-input-box {
            background: #121214;
            border: 1.5px solid #444446;
            border-radius: 18px;
            width: 100%;
            height: 56px;
            color: white;
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .mode-90 .input-themed { border: 3px solid var(--accent-90); }
        .mode-45 .input-themed { border: 3px solid var(--accent-45); }
        .mode-dist .input-themed { border: 3px solid var(--accent-dist); }

        .label-outside {
            font-size: 15px;
            color: #d1d1d6;
            margin-left: 8px;
            margin-bottom: 6px;
            font-weight: 700;
        }

        .result-box {
            height: 104px;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 24px;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
        }
        .result-box:active { transform: scale(0.98); }

        .mode-90 .result-box-elbow { background: var(--accent-90); }
        .mode-45 .result-box-elbow { background: var(--accent-45); }
        .mode-dist .result-box-dist { background: var(--accent-dist); }

        .btn-3d {
            width: 100%;
            height: 58px;
            border-radius: 18px;
            font-weight: 800;
            font-size: 18px;
            cursor: pointer;
            border: none;
            position: relative;
            top: 0;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-gray-3d {
            background: #3a3a3c;
            color: white;
            border-bottom: 6px solid #1a1a1a;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .btn-gray-3d:active {
            top: 4px;
            border-bottom-width: 2px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* 履歴リスト */
        .history-item {
            background: var(--ios-input);
            border-radius: 14px;
            padding: 10px 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1.5px solid #3a3c3e;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .history-item.is-locked {
            background: #2c2c2e;
            border: 2px solid var(--ios-orange);
            box-shadow: 0 0 12px rgba(255, 159, 10, 0.3);
        }

        .lock-btn {
            padding: 8px;
            border-radius: 10px;
            background: #3a3a3c;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .lock-btn.active {
            background: var(--ios-orange);
            color: white;
        }

        #toast {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: var(--accent-dist);
            color: white;
            padding: 10px 24px;
            border-radius: 50px;
            font-weight: bold;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
            pointer-events: none;
        }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        #modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: var(--ios-card);
            width: 85%;
            max-width: 320px;
            border-radius: 20px;
            padding: 24px;
            text-align: center;
            border: 1px solid var(--ios-border);
        }

        .hidden { display: none !important; }
        .footer { text-align: center; margin-top: 24px; font-size: 12px; color: var(--ios-secondary); letter-spacing: 0.05em; font-weight: 600; }
    </style>
</head>
<body class="mode-90">

    <div id="toast">コピーしました</div>

    <!-- 削除確認モーダル -->
    <div id="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-2">履歴をクリア</h3>
            <p class="text-zinc-400 text-sm mb-6">ロックされていない履歴をすべて削除しますか？</p>
            <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-3 bg-zinc-800 rounded-xl font-bold">キャンセル</button>
                <button onclick="confirmClearHistory()" class="flex-1 py-3 bg-red-600 rounded-xl font-bold">削除する</button>
            </div>
        </div>
    </div>

    <div class="tab-wrapper">
        <div class="tab-container">
            <button class="tab-button active" id="nav-90" onclick="switchTab('90')">90°エルボ</button>
            <button class="tab-button" id="nav-45" onclick="switchTab('45')">45°エルボ</button>
            <button class="tab-button" id="nav-dist" onclick="switchTab('dist')">距離計算</button>
        </div>
    </div>

    <div class="main-container" id="app-container">
        <!-- エルボ計算セクション -->
        <div id="section-elbow" class="flex flex-col flex-1">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold" id="elbow-title">90°エルボ 計算</h1>
                <p class="text-xs text-gray-400 tracking-widest mt-1 font-bold">KYOWA ROOF</p>
            </div>

            <div class="result-box result-box-elbow" onclick="copyResult('elbow-result-val')">
                <span class="text-[15px] font-bold opacity-80 mb-1">切寸法</span>
                <div class="flex items-baseline gap-1">
                    <span class="text-4xl font-black" id="elbow-result-val">---</span>
                    <span class="text-lg font-bold opacity-80">mm</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <div class="label-outside">サイズ</div>
                    <select id="elbow-size" class="ios-input-box input-themed cursor-pointer" onchange="elbowCalc()">
                        <option value="75">75</option>
                        <option value="100" selected>100</option>
                        <option value="125">125</option>
                    </select>
                </div>
                <div>
                    <div class="label-outside">重寸法</div>
                    <div class="ios-input-box flex items-center justify-center bg-zinc-900 border-zinc-800 text-zinc-400">
                        <span id="elbow-d-val">--</span><span class="text-sm ml-1">mm</span>
                    </div>
                </div>
            </div>

            <div class="mb-8">
                <div class="label-outside">寸法 (mm)</div>
                <input type="text" id="elbow-input" class="ios-input-box h-16 text-3xl input-themed" inputmode="decimal" placeholder="0" oninput="elbowCalc()">
            </div>

            <div class="border-t border-zinc-800 pt-4 flex-1">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-sm font-bold text-zinc-500 uppercase tracking-wider">履歴 (オレンジは保護中)</span>
                    <button class="text-sm text-red-500 font-bold px-2 py-1" onclick="openModal()">クリア</button>
                </div>
                <div id="elbow-history-list" class="space-y-1"></div>
            </div>
            <div class="footer">入力後に自動保存されます(3件まで)</div>
        </div>

        <!-- 距離計算セクション -->
        <div id="section-dist" class="hidden flex flex-col flex-1">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold">距離計算</h1>
                <p class="text-xs text-gray-400 tracking-widest mt-1 font-bold">KYOWA ROOF</p>
            </div>

            <div class="result-box result-box-dist" id="dist-result-container" onclick="copyResult('dist-result-val')">
                <span class="text-[15px] font-bold opacity-80 mb-1">計算結果</span>
                <div class="flex items-baseline gap-1">
                    <span class="text-4xl font-black" id="dist-result-val">---</span>
                    <span class="text-lg font-bold opacity-80">mm</span>
                </div>
            </div>

            <div class="space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <div class="label-outside">足長</div>
                        <input type="text" id="dist-input-b" class="ios-input-box text-2xl input-themed" inputmode="numeric" placeholder="0">
                    </div>
                    <div>
                        <div class="label-outside">並行距離</div>
                        <input type="text" id="dist-input-h" class="ios-input-box text-2xl input-themed" inputmode="numeric" placeholder="0">
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-1">
                        <div class="label-outside">選択</div>
                        <select id="dist-select-x" class="ios-input-box text-2xl input-themed cursor-pointer">
                            <option value="45">75</option>
                            <option value="57" selected>100</option>
                            <option value="70">125</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <div class="label-outside">寸法</div>
                        <input type="text" id="dist-input-a" class="ios-input-box text-2xl input-themed" inputmode="numeric" placeholder="0">
                    </div>
                </div>

                <div class="flex justify-center pt-4">
                    <button onclick="clearDistFields()" class="btn-3d btn-gray-3d w-1/2 text-white font-bold py-3 rounded-xl text-lg">
                        クリア
                    </button>
                </div>
            </div>
            <div class="footer">結果をタップしてコピー</div>
        </div>

        <div class="text-center text-[10px] text-zinc-600 mt-6 pb-2">
            &copy; KYOWA ROOF TOOL
        </div>
    </div>

<script>
    let currentTab = '90';
    const storageKey = 'kyowa_unified_v5';
    
    const tabStates = {
        '90': { input: '', size: '100' },
        '45': { input: '', size: '100' },
        'dist': { b: '', h: '', x: '57', a: '' }
    };

    let histories = JSON.parse(localStorage.getItem(storageKey)) || [];

    const elbowData = {
        "90": { 75: { d: 30, e: 88 }, 100: { d: 40, e: 112 }, 125: { d: 50, e: 140 } },
        "45": { 75: { d: 30, e: 65 }, 100: { d: 40, e: 80 }, 125: { d: 50, e: 103 } }
    };

    function formatNum(num) {
        if (num === null || isNaN(num) || num === "") return "---";
        const parts = num.toString().split(".");
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return parts.join(".");
    }

    function unformatNum(str) { return str.toString().replace(/,/g, ""); }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }

    function copyResult(elementId) {
        const val = document.getElementById(elementId).innerText;
        if (val === "---" || val === "エラー") return;
        const temp = document.createElement('textarea');
        temp.value = unformatNum(val);
        document.body.appendChild(temp);
        temp.select();
        document.execCommand('copy');
        document.body.removeChild(temp);
        showToast("コピーしました");
    }

    function openModal() { document.getElementById('modal-overlay').style.display = 'flex'; }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

    function switchTab(tabId) {
        if (tabId === currentTab) return;
        
        if (currentTab === 'dist') {
            tabStates.dist.b = document.getElementById('dist-input-b').value;
            tabStates.dist.h = document.getElementById('dist-input-h').value;
            tabStates.dist.x = document.getElementById('dist-select-x').value;
            tabStates.dist.a = document.getElementById('dist-input-a').value;
        } else {
            tabStates[currentTab].input = document.getElementById('elbow-input').value;
            tabStates[currentTab].size = document.getElementById('elbow-size').value;
        }

        currentTab = tabId;
        
        ['90', '45', 'dist'].forEach(id => {
            document.getElementById(`nav-${id}`).classList.toggle('active', id === tabId);
        });

        const sectionElbow = document.getElementById('section-elbow');
        const sectionDist = document.getElementById('section-dist');

        if (tabId === 'dist') {
            sectionElbow.classList.add('hidden');
            sectionDist.classList.remove('hidden');
            document.body.className = 'mode-dist';
        } else {
            sectionElbow.classList.remove('hidden');
            sectionDist.classList.add('hidden');
            document.body.className = `mode-${tabId}`;
            document.getElementById('elbow-title').innerText = `${tabId}°エルボ 計算`;
        }

        if (tabId === 'dist') {
            document.getElementById('dist-input-b').value = tabStates.dist.b;
            document.getElementById('dist-input-h').value = tabStates.dist.h;
            document.getElementById('dist-select-x').value = tabStates.dist.x;
            document.getElementById('dist-input-a').value = tabStates.dist.a;
            distCalc();
        } else {
            document.getElementById('elbow-input').value = tabStates[tabId].input;
            document.getElementById('elbow-size').value = tabStates[tabId].size;
            elbowCalc();
            renderElbowHistory();
        }
        window.scrollTo(0, 0);
    }

    function elbowCalc() {
        if (currentTab === 'dist') return;
        const size = document.getElementById('elbow-size').value;
        const inputEl = document.getElementById('elbow-input');
        let rawInput = unformatNum(inputEl.value).replace(/[^\d.]/g, "");

        if (rawInput !== "") {
            const parts = rawInput.split(".");
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            inputEl.value = parts.join(".");
        }

        const { d, e } = elbowData[currentTab][size];
        document.getElementById('elbow-d-val').innerText = d;

        const c = parseFloat(rawInput);
        const resultEl = document.getElementById('elbow-result-val');

        if (isNaN(c)) {
            resultEl.innerText = "---";
            return;
        }

        let res = currentTab === "90" ? Math.round((c - ((e * 2) - (d * 2))) * 10) / 10 : Math.ceil((c / Math.cos(45 * Math.PI / 180)) - ((e - d) * 2));
        resultEl.innerText = formatNum(res);
        tabStates[currentTab].input = inputEl.value;
    }

    function saveElbowHistory() {
        const size = document.getElementById('elbow-size').value;
        const input = document.getElementById('elbow-input').value;
        const result = document.getElementById('elbow-result-val').innerText;
        if (result === "---") return;

        // 同じ内容が直近に保存されていないかチェック
        const last = histories[histories.length - 1];
        if (last && last.mode === currentTab && last.input === input && last.size === size) return;

        // 自動保存の制限（ロックされていないものを削除対象にする）
        const autos = histories.filter(h => h.mode === currentTab && !h.locked);
        if (autos.length >= 3) {
            const oldestIdx = histories.findIndex(h => h.mode === currentTab && !h.locked);
            if (oldestIdx !== -1) histories.splice(oldestIdx, 1);
        }

        histories.push({ 
            id: Date.now(), 
            mode: currentTab, 
            size, 
            input, 
            result, 
            locked: false 
        });
        
        saveToStorage();
        renderElbowHistory();
    }

    function renderElbowHistory() {
        const listEl = document.getElementById('elbow-history-list');
        listEl.innerHTML = "";
        
        // ソート: 保護(locked)されているものを上、次にID(新しい順)
        const filtered = histories.filter(h => h.mode === currentTab).sort((a, b) => {
            if (a.locked !== b.locked) return b.locked ? 1 : -1;
            return b.id - a.id;
        });
        
        if (filtered.length === 0) { 
            listEl.innerHTML = '<div class="text-center py-6 text-zinc-700 text-xs font-bold">履歴はありません</div>'; 
            return; 
        }

        filtered.forEach(item => {
            const div = document.createElement('div');
            div.className = `history-item ${item.locked ? 'is-locked' : ''}`;
            
            const lockIcon = item.locked ? 
                '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>' :
                '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>';

            div.innerHTML = `
                <div class="flex items-center gap-3">
                    <button onclick="toggleLock(${item.id})" class="lock-btn ${item.locked ? 'active' : 'text-zinc-500'}">
                        ${lockIcon}
                    </button>
                    <div class="flex flex-col">
                        <div class="flex items-center gap-2">
                            <span class="bg-zinc-800 text-[10px] px-1.5 py-0.5 rounded border border-zinc-700 font-bold text-white">${item.size}</span>
                            <span class="text-[11px] text-zinc-500">入:${item.input}</span>
                        </div>
                        <span class="font-black text-xl leading-tight">${item.result}</span>
                    </div>
                </div>
                <div>
                    ${!item.locked ? `
                        <button onclick="deleteHistory(${item.id})" class="text-red-500/50 hover:text-red-500 font-bold text-2xl p-2 transition-colors">&times;</button>
                    ` : `
                        <span class="text-orange-500 p-2 text-[10px] font-black tracking-tighter">FIXED</span>
                    `}
                </div>`;
            listEl.appendChild(div);
        });
    }

    function toggleLock(id) {
        const item = histories.find(h => h.id === id);
        if (item) {
            item.locked = !item.locked;
            saveToStorage();
            renderElbowHistory();
        }
    }

    function deleteHistory(id) {
        const item = histories.find(h => h.id === id);
        if (item && !item.locked) {
            histories = histories.filter(h => h.id !== id);
            saveToStorage();
            renderElbowHistory();
        }
    }

    function confirmClearHistory() {
        histories = histories.filter(h => h.mode !== currentTab || h.locked);
        saveToStorage();
        renderElbowHistory();
        closeModal();
    }

    function saveToStorage() {
        localStorage.setItem(storageKey, JSON.stringify(histories));
    }

    function distCalc() {
        const bRaw = unformatNum(document.getElementById('dist-input-b').value);
        const hRaw = unformatNum(document.getElementById('dist-input-h').value);
        const aRaw = unformatNum(document.getElementById('dist-input-a').value);
        const xVal = parseFloat(document.getElementById('dist-select-x').value);
        const resValEl = document.getElementById('dist-result-val');
        if (!hRaw || !bRaw || !aRaw) { resValEl.innerText = "---"; return; }
        const h = parseFloat(hRaw), bBase = parseFloat(bRaw), a = parseFloat(aRaw);
        const bCalc = bBase + xVal;
        const cSq = (a * a) + (bCalc * bCalc) - (2 * bCalc * h);
        resValEl.innerText = cSq < 0 ? "エラー" : formatNum(Math.ceil(Math.sqrt(cSq)));
    }

    function clearDistFields() {
        ['dist-input-b', 'dist-input-h', 'dist-input-a'].forEach(id => document.getElementById(id).value = "");
        document.getElementById('dist-result-val').innerText = "---";
        document.getElementById('dist-input-b').focus();
    }

    window.onload = () => {
        const elbowInput = document.getElementById('elbow-input');
        elbowInput.addEventListener('keydown', e => { 
            if (e.key === 'Enter') { 
                saveElbowHistory(); 
                elbowInput.blur(); 
            } 
        });
        elbowInput.addEventListener('blur', () => { 
            if (elbowInput.value && elbowInput.value !== "0") saveElbowHistory(); 
        });
        
        ['dist-input-b', 'dist-input-h', 'dist-input-a'].forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('input', (e) => {
                let val = unformatNum(e.target.value).replace(/[^\d.]/g, "");
                if (val !== "") e.target.value = formatNum(val);
                distCalc();
            });
            el.addEventListener('focus', () => el.select());
        });
        document.getElementById('dist-select-x').addEventListener('change', distCalc);

        elbowCalc();
        renderElbowHistory();
    };
</script>
</body>
</html>