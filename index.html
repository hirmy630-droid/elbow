<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>エルホ距離計算</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --ios-bg: #000000;
            --ios-card: #1c1c1e;
            --ios-input: #2c2c2e;
            --ios-orange: #e68a00;
            --ios-orange-dark: #995c00;
            --ios-orange-light: #ffaa33;
            --accent-90: #5e5ce6;
            --accent-45: #30d158;
            --accent-dist: #3b82f6;
        }

        * {
            box-sizing: border-box;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            background: var(--ios-bg);
            font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
            color: #ffffff;
            display: flex;
            justify-content: center;
            padding: 10px 6px;
            overflow-x: hidden;
            touch-action: pan-y;
        }

        /* 共通カード */
        .main-container {
            width: 100%;
            max-width: 450px;
            background: var(--ios-card);
            border-radius: 28px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            position: relative;
            min-height: 85vh;
            display: flex;
            flex-direction: column;
            transition: border 0.3s ease;
        }

        /* メインタブナビゲーション */
        .main-nav {
            display: flex;
            gap: 6px;
            margin-bottom: 24px;
            background: #2c2c2e;
            padding: 4px;
            border-radius: 14px;
            z-index: 10;
        }

        .nav-btn {
            flex: 1;
            padding: 12px 4px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 700;
            color: #8e8e93;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .nav-btn.active {
            background: #48484a;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* 入力ボックス共通 */
        .ios-input-box {
            background: var(--ios-input);
            border: 1.5px solid #3a3a3c;
            border-radius: 16px;
            width: 100%;
            height: 54px;
            color: white;
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        /* モードごとの入力枠色 (エルボ 90°) */
        .mode-90 .input-themed { border: 2px solid var(--accent-90); box-shadow: 0 0 8px rgba(94, 92, 230, 0.2); }
        /* モードごとの入力枠色 (エルボ 45°) */
        .mode-45 .input-themed { border: 2px solid var(--accent-45); box-shadow: 0 0 8px rgba(48, 209, 88, 0.2); }
        /* モードごとの入力枠色 (距離計算) */
        .mode-dist .input-themed { border: 2px solid var(--accent-dist); box-shadow: 0 0 8px rgba(59, 130, 246, 0.2); }

        .label-text {
            font-size: 13px;
            color: #8e8e93;
            margin-left: 8px;
            margin-bottom: 4px;
            font-weight: 600;
        }

        /* 結果表示 */
        .result-box {
            height: 100px;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .mode-90 .result-box-elbow { background: var(--accent-90); box-shadow: 0 8px 16px rgba(94, 92, 230, 0.3); }
        .mode-45 .result-box-elbow { background: var(--accent-45); box-shadow: 0 8px 16px rgba(48, 209, 88, 0.3); }
        .mode-dist .result-box-dist { background: var(--accent-dist); box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3); }

        /* ボタン */
        .btn-3d {
            width: 100%;
            height: 56px;
            border-radius: 16px;
            font-weight: 800;
            font-size: 17px;
            cursor: pointer;
            border: none;
            position: relative;
            top: 0;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-orange {
            background: linear-gradient(180deg, var(--ios-orange-light) 0%, var(--ios-orange) 100%);
            color: white;
            box-shadow: 0 5px 0 var(--ios-orange-dark);
        }
        .btn-orange:active {
            top: 3px;
            box-shadow: 0 2px 0 var(--ios-orange-dark);
        }
        .btn-orange:disabled {
            background: #2c2c2e;
            color: #48484a;
            box-shadow: none;
            top: 0;
        }

        /* 立体的なクリアボタン用スタイル */
        .btn-gray {
            background: linear-gradient(180deg, #636366 0%, #3a3a3c 100%);
            color: white;
            box-shadow: 0 5px 0 #1c1c1e;
        }
        .btn-gray:active {
            top: 3px;
            box-shadow: 0 2px 0 #1c1c1e;
        }

        /* 履歴リスト */
        .history-item {
            background: #1c1c1e;
            border: 1px solid #3a3a3c;
            border-radius: 12px;
            padding: 10px 14px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* トースト */
        #toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(48, 209, 88, 0.9);
            color: white;
            padding: 10px 24px;
            border-radius: 30px;
            font-weight: 700;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
            pointer-events: none;
        }

        #toast.show { opacity: 1; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="main-container mode-90" id="app-container">
    <div id="toast">コピーしました</div>

    <!-- メインタブ -->
    <div class="main-nav">
        <div class="nav-btn active" id="nav-90" onclick="switchTab('90')">90°エルボ</div>
        <div class="nav-btn" id="nav-45" onclick="switchTab('45')">45°エルボ</div>
        <div class="nav-btn" id="nav-dist" onclick="switchTab('dist')">距離計算</div>
    </div>

    <!-- エルボ計算セクション -->
    <div id="section-elbow" class="flex flex-col flex-1">
        <div class="text-center mb-6">
            <h1 class="text-xl font-bold" id="elbow-title">90°エルボ 計算</h1>
            <p class="text-xs text-gray-500 tracking-widest mt-1">KYOWA ROOF</p>
        </div>

        <div class="result-box result-box-elbow mb-6">
            <span class="text-xs font-bold opacity-80 mb-1">切寸法</span>
            <div class="flex items-baseline gap-1">
                <span class="text-4xl font-black" id="elbow-result-val">---</span>
                <span class="text-lg font-bold opacity-80">mm</span>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
                <div class="label-text">サイズ</div>
                <select id="elbow-size" class="ios-input-box input-themed" onchange="elbowCalc()">
                    <option value="75">75</option>
                    <option value="100" selected>100</option>
                    <option value="125">125</option>
                </select>
            </div>
            <div>
                <div class="label-text">重寸法</div>
                <div class="ios-input-box flex items-center justify-center bg-zinc-900 border-zinc-800 text-zinc-400">
                    <span id="elbow-d-val">--</span><span class="text-sm ml-1">mm</span>
                </div>
            </div>
        </div>

        <div class="mb-6">
            <div class="label-text">寸法 (mm)</div>
            <input type="text" id="elbow-input" class="ios-input-box h-16 text-3xl input-themed" inputmode="decimal" placeholder="0" oninput="elbowCalc()">
        </div>

        <button id="elbow-save-btn" class="btn-3d btn-orange mb-8" disabled onclick="saveElbowHistory('button')">
            ★ 履歴に保存
        </button>

        <div class="border-t border-zinc-800 pt-4 flex-1">
            <div class="flex justify-between items-center mb-4">
                <span class="text-xs font-bold text-zinc-500">保存された履歴</span>
                <button class="text-xs text-red-500 font-bold" onclick="clearElbowHistory()">クリア</button>
            </div>
            <div id="elbow-history-list" class="space-y-2"></div>
        </div>
    </div>

    <!-- 距離計算セクション -->
    <div id="section-dist" class="hidden flex flex-col flex-1">
        <div class="text-center mb-6">
            <h1 class="text-xl font-bold">距離計算</h1>
            <p class="text-xs text-gray-500 tracking-widest mt-1">KYOWA ROOF</p>
        </div>

        <div class="result-box result-box-dist cursor-pointer" id="dist-result-container" onclick="copyDistResult()">
            <span class="text-xs font-bold opacity-80 mb-1">計算結果 (タップでコピー)</span>
            <div class="flex items-baseline gap-1">
                <span class="text-4xl font-black" id="dist-result-val">---</span>
                <span class="text-lg font-bold opacity-80">mm</span>
            </div>
        </div>

        <div class="space-y-5">
            <div class="grid grid-cols-3 gap-3">
                <div class="col-span-1">
                    <div class="label-text">足長</div>
                    <input type="text" id="dist-input-b" class="ios-input-box text-lg input-themed" inputmode="numeric" placeholder="0">
                </div>
                <div class="col-span-2">
                    <div class="label-text">並行距離</div>
                    <input type="text" id="dist-input-h" class="ios-input-box text-lg input-themed" inputmode="numeric" placeholder="0">
                </div>
            </div>

            <div class="grid grid-cols-3 gap-3">
                <div class="col-span-1">
                    <div class="label-text">選択</div>
                    <select id="dist-select-x" class="ios-input-box text-lg input-themed">
                        <option value="45">75</option>
                        <option value="57" selected>100</option>
                        <option value="70">125</option>
                    </select>
                </div>
                <div class="col-span-2">
                    <div class="label-text">寸法</div>
                    <input type="text" id="dist-input-a" class="ios-input-box text-lg input-themed" inputmode="numeric" placeholder="0">
                </div>
            </div>

            <div class="flex justify-center pt-8">
                <button onclick="clearDistFields()" class="btn-3d btn-gray w-1/2">
                    クリア
                </button>
            </div>
        </div>
    </div>

    <div class="text-center text-[10px] text-zinc-600 mt-6 pb-2">
        &copy; KYOWA ROOF TOOL
    </div>
</div>

<script>
    // --- 状態管理（各タブの入力値を独立させる） ---
    let currentTab = '90';
    const storageKey = 'kyowa_unified_v2';
    
    // 各モードの入力状態を保持
    const tabStates = {
        '90': { input: '', size: '100' },
        '45': { input: '', size: '100' },
        'dist': { b: '', h: '', x: '57', a: '' }
    };

    let histories = JSON.parse(localStorage.getItem(storageKey)) || [];

    const elbowData = {
        "90": { 75: { d: 30, e: 88 }, 100: { d: 40, e: 112 }, 125: { d: 50, e: 140 } },
        "45": { 75: { d: 30, e: 65 }, 100: { d: 40, e: 80 }, 125: { d: 50, e: 103 } }
    };

    // --- ユーティリティ ---
    function formatNum(num) {
        if (num === null || isNaN(num) || num === "") return "---";
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function unformatNum(str) {
        return str.toString().replace(/,/g, "");
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }

    // --- タブ切り替えロジック ---
    function switchTab(tabId) {
        if (tabId === currentTab) return;

        // 現在の状態を保存
        saveCurrentState();

        currentTab = tabId;
        
        // UI更新
        ['90', '45', 'dist'].forEach(id => {
            document.getElementById(`nav-${id}`).classList.toggle('active', id === tabId);
        });

        const container = document.getElementById('app-container');
        const sectionElbow = document.getElementById('section-elbow');
        const sectionDist = document.getElementById('section-dist');

        if (tabId === 'dist') {
            sectionElbow.classList.add('hidden');
            sectionDist.classList.remove('hidden');
            container.className = 'main-container mode-dist';
        } else {
            sectionElbow.classList.remove('hidden');
            sectionDist.classList.add('hidden');
            container.className = `main-container mode-${tabId}`;
            document.getElementById('elbow-title').innerText = `${tabId}°エルボ 計算`;
        }

        // 保存されていた状態を復元
        restoreState(tabId);
        
        // 再計算と履歴表示
        if (tabId !== 'dist') {
            elbowCalc();
            renderElbowHistory();
        } else {
            distCalc();
        }
    }

    function saveCurrentState() {
        if (currentTab === 'dist') {
            tabStates.dist.b = document.getElementById('dist-input-b').value;
            tabStates.dist.h = document.getElementById('dist-input-h').value;
            tabStates.dist.x = document.getElementById('dist-select-x').value;
            tabStates.dist.a = document.getElementById('dist-input-a').value;
        } else {
            tabStates[currentTab].input = document.getElementById('elbow-input').value;
            tabStates[currentTab].size = document.getElementById('elbow-size').value;
        }
    }

    function restoreState(tabId) {
        if (tabId === 'dist') {
            document.getElementById('dist-input-b').value = tabStates.dist.b;
            document.getElementById('dist-input-h').value = tabStates.dist.h;
            document.getElementById('dist-select-x').value = tabStates.dist.x;
            document.getElementById('dist-input-a').value = tabStates.dist.a;
        } else {
            document.getElementById('elbow-input').value = tabStates[tabId].input;
            document.getElementById('elbow-size').value = tabStates[tabId].size;
        }
    }

    // --- スワイプ機能 ---
    let touchStartX = 0;
    let touchEndX = 0;
    const tabs = ['90', '45', 'dist'];

    document.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
    }, {passive: true});

    document.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    }, {passive: true});

    function handleSwipe() {
        const swipeDistance = touchEndX - touchStartX;
        const threshold = 70; // スワイプと判定する距離

        if (Math.abs(swipeDistance) > threshold) {
            let currentIndex = tabs.indexOf(currentTab);
            if (swipeDistance > 0) {
                // 右スワイプ -> 前のタブ
                if (currentIndex > 0) switchTab(tabs[currentIndex - 1]);
            } else {
                // 左スワイプ -> 次のタブ
                if (currentIndex < tabs.length - 1) switchTab(tabs[currentIndex + 1]);
            }
        }
    }

    // --- エルボ計算 ---
    function elbowCalc() {
        if (currentTab === 'dist') return;
        
        const size = document.getElementById('elbow-size').value;
        const inputEl = document.getElementById('elbow-input');
        let valStr = inputEl.value;
        let rawInput = unformatNum(valStr).replace(/[^\d.]/g, "");

        if (rawInput !== "") {
            const parts = rawInput.split(".");
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            const formatted = parts.join(".");
            if (valStr !== formatted) inputEl.value = formatted;
        }

        const { d, e } = elbowData[currentTab][size];
        document.getElementById('elbow-d-val').innerText = d;

        const c = parseFloat(rawInput);
        const resultEl = document.getElementById('elbow-result-val');
        const saveBtn = document.getElementById('elbow-save-btn');

        if (isNaN(c)) {
            resultEl.innerText = "---";
            saveBtn.disabled = true;
            return;
        }

        let res;
        if (currentTab === "90") {
            res = Math.round((c - ((e * 2) - (d * 2))) * 10) / 10;
        } else {
            const cos45 = Math.cos(45 * Math.PI / 180);
            res = Math.ceil((c / cos45) - ((e - d) * 2));
        }

        resultEl.innerText = formatNum(res);
        saveBtn.disabled = false;
        
        // 状態を随時保存
        tabStates[currentTab].input = inputEl.value;
        tabStates[currentTab].size = size;
    }

    function saveElbowHistory(method = 'enter') {
        const size = document.getElementById('elbow-size').value;
        const input = document.getElementById('elbow-input').value;
        const result = document.getElementById('elbow-result-val').innerText;
        
        if (result === "---") return;

        const newItem = {
            id: Date.now(),
            mode: currentTab,
            size,
            input,
            result,
            method
        };

        if (method === 'enter') {
            const autos = histories.filter(h => h.mode === currentTab && h.method === 'enter');
            if (autos.length >= 5) {
                const oldestIdx = histories.findIndex(h => h.mode === currentTab && h.method === 'enter');
                if (oldestIdx !== -1) histories.splice(oldestIdx, 1);
            }
        }

        histories.push(newItem);
        localStorage.setItem(storageKey, JSON.stringify(histories));
        renderElbowHistory();

        const btn = document.getElementById('elbow-save-btn');
        btn.innerText = "✓ 保存しました";
        setTimeout(() => btn.innerText = "★ 履歴に保存", 800);
    }

    function renderElbowHistory() {
        const listEl = document.getElementById('elbow-history-list');
        listEl.innerHTML = "";
        const filtered = histories.filter(h => h.mode === currentTab).reverse();

        if (filtered.length === 0) {
            listEl.innerHTML = '<div class="text-center py-4 text-zinc-700 text-xs">履歴はありません</div>';
            return;
        }

        filtered.forEach(item => {
            const div = document.createElement('div');
            div.className = "history-item";
            div.innerHTML = `
                <div class="flex items-center gap-2">
                    ${item.method === 'button' ? '<span class="text-orange-500 font-bold">★</span>' : ''}
                    <span class="bg-zinc-800 text-[10px] px-2 py-0.5 rounded border border-zinc-700 font-bold">${item.size}</span>
                    <span class="text-xs text-zinc-400">入:${item.input}</span>
                </div>
                <div class="flex items-center gap-3">
                    <span class="font-black text-lg">${item.result}</span>
                    <button onclick="deleteHistory(${item.id})" class="text-red-500 font-bold text-xl px-2">&times;</button>
                </div>
            `;
            listEl.appendChild(div);
        });
    }

    function deleteHistory(id) {
        histories = histories.filter(h => h.id !== id);
        localStorage.setItem(storageKey, JSON.stringify(histories));
        renderElbowHistory();
    }

    function clearElbowHistory() {
        if (confirm(`${currentTab}°エルボの履歴をクリアしますか？`)) {
            histories = histories.filter(h => h.mode !== currentTab);
            localStorage.setItem(storageKey, JSON.stringify(histories));
            renderElbowHistory();
        }
    }

    // --- 距離計算 ---
    function distCalc() {
        const bRaw = unformatNum(document.getElementById('dist-input-b').value);
        const hRaw = unformatNum(document.getElementById('dist-input-h').value);
        const aRaw = unformatNum(document.getElementById('dist-input-a').value);
        const xVal = parseFloat(document.getElementById('dist-select-x').value);
        const resValEl = document.getElementById('dist-result-val');

        if (!hRaw || !bRaw || !aRaw) {
            resValEl.innerText = "---";
            return;
        }

        const h = parseFloat(hRaw), bBase = parseFloat(bRaw), a = parseFloat(aRaw);
        const bCalc = bBase + xVal;
        const cSquared = (a * a) + (bCalc * bCalc) - (2 * bCalc * h);

        if (cSquared < 0) {
            resValEl.innerText = "エラー";
        } else {
            const res = Math.ceil(Math.sqrt(cSquared));
            resValEl.innerText = formatNum(res);
        }
        
        // 状態保存
        tabStates.dist = {
            b: document.getElementById('dist-input-b').value,
            h: document.getElementById('dist-input-h').value,
            x: document.getElementById('dist-select-x').value,
            a: document.getElementById('dist-input-a').value
        };
    }

    function clearDistFields() {
        ['dist-input-b', 'dist-input-h', 'dist-input-a'].forEach(id => document.getElementById(id).value = "");
        document.getElementById('dist-result-val').innerText = "---";
        tabStates.dist = { b: '', h: '', x: '57', a: '' };
        document.getElementById('dist-input-b').focus();
    }

    function copyDistResult() {
        const res = document.getElementById('dist-result-val').innerText;
        if (res === "---" || res === "エラー") return;
        const temp = document.createElement('textarea');
        temp.value = unformatNum(res);
        document.body.appendChild(temp);
        temp.select();
        document.execCommand('copy');
        document.body.removeChild(temp);
        showToast("コピーしました");
    }

    // --- 初期化 ---
    function init() {
        // エルボイベント
        const elbowInput = document.getElementById('elbow-input');
        elbowInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                saveElbowHistory('enter');
                elbowInput.blur();
            }
        });
        elbowInput.addEventListener('blur', () => {
            if (elbowInput.value && elbowInput.value !== "0") saveElbowHistory('enter');
        });

        // 距離計算イベント
        const distIds = ['dist-input-b', 'dist-input-h', 'dist-input-a'];
        distIds.forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('input', (e) => {
                let val = unformatNum(e.target.value);
                if (val !== "" && !isNaN(val)) e.target.value = formatNum(val);
                distCalc();
            });
            el.addEventListener('focus', () => el.select());
        });
        document.getElementById('dist-select-x').addEventListener('change', distCalc);

        // Enterでのフォーカス移動
        document.getElementById('dist-input-b').onkeydown = e => { if(e.key === 'Enter') document.getElementById('dist-input-h').focus(); };
        document.getElementById('dist-input-h').onkeydown = e => { if(e.key === 'Enter') document.getElementById('dist-select-x').focus(); };
        document.getElementById('dist-select-x').onkeydown = e => { if(e.key === 'Enter') document.getElementById('dist-input-a').focus(); };
        document.getElementById('dist-input-a').onkeydown = e => { if(e.key === 'Enter') { distCalc(); document.getElementById('dist-input-b').focus(); }};

        elbowCalc();
        renderElbowHistory();
    }

    window.onload = init;
</script>

</body>
</html>